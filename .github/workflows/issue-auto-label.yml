name: Auto label issues

# yamllint disable-line rule:truthy
on:
  issues:
    types: [opened, edited, reopened]

permissions:
  issues: write

jobs:
  auto-label:
    runs-on: ubuntu-latest
    steps:
      - name: Extract integration and apply labels
        uses: actions/github-script@v7.0.1
        with:
          script: |
            const issue = context.payload.issue;
            if (!issue) {
              core.info('No issue in payload, skipping');
              return;
            }

            const body = issue.body || '';
            const match = body.match(/^-+\s*Integration causing this issue:\s*(.+)$/im);
            const rawValue = match ? match[1].trim() : '';

            if (!rawValue || rawValue === '-' || rawValue.toLowerCase() === 'n/a') {
              core.info('No integration field provided, skipping integration label');
              return;
            }

            const normalized = rawValue
              .toLowerCase()
              .replace(/[^\w\s-]/g, '')
              .replace(/\s+/g, '_')
              .replace(/_+/g, '_')
              .slice(0, 50);

            if (!normalized) {
              core.info('Integration value normalized to empty, skipping');
              return;
            }

            const labelName = `integration:${normalized}`;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issueNumber = issue.number;

            const applyLabel = async () => {
              await github.rest.issues.addLabels({
                owner,
                repo,
                issue_number: issueNumber,
                labels: [labelName],
              });
            };

            try {
              await applyLabel();
              core.info(`Applied label: ${labelName}`);
              return;
            } catch (error) {
              if (error.status !== 404) {
                core.error(`Failed to add label: ${error.message}`);
                throw error;
              }
            }

            // Create label if it does not exist, then apply.
            try {
              await github.rest.issues.createLabel({
                owner,
                repo,
                name: labelName,
                color: '0366d6',
                description: `Integration label for ${rawValue}`,
              });
              await applyLabel();
              core.info(`Created and applied label: ${labelName}`);
            } catch (error) {
              core.error(`Failed to create/apply label: ${error.message}`);
              throw error;
            }

